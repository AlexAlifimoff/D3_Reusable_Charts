<html>
<head>
<style>

.chart-wrapper {
    max-width: 650px;
    min-width: 304px;
    margin: 8px auto;
    background-color: #FAF7F7;
}

.chart-wrapper .inner-wrapper {
    position: relative;
    padding-bottom: 50%;
    width: 100%;
}

.chart-wrapper .outer-box {
    position: absolute;
    top: 0; bottom: 0; left: 0; right: 0;
}

.chart-wrapper .inner-box {
    width: 100%;
    height: 100%;
}

.chart-wrapper text {
  font-family: sans-serif;
  font-size: 11px;
}

.chart-wrapper p {
    font-size: 16px;
    margin-top:5px;
    margin-bottom: 40px;
}

.chart-wrapper .axis path,
.chart-wrapper .axis line {
    fill: none;
    stroke: #1F1F2E;
    stroke-opacity: 0.7;
    shape-rendering: crispEdges;

}
.chart-wrapper .axis path {
  stroke-width: 2px;
}

.chart-wrapper .line {
  fill: none;
  stroke: steelblue;
  stroke-width: 5px;
}

.chart-wrapper .legend  {
    min-width: 200px;
    display: flex;
    justify-content: flex-start;
    flex-wrap: wrap;
    font-size: 16px;
    padding: 10px 40px;
}
.chart-wrapper .legend > div {
    margin: 0px 25px 10px 0px;
    flex-grow: 0;
}
.chart-wrapper .legend p {
    display:inline;
    font-size: 0.8em;
    font-family: sans-serif;
    font-weight: 600;
}
.chart-wrapper .legend .series-marker {
    height: 1em;
    width: 1em;
    border-radius: 35%;
    background-color: crimson;
    display: inline-block;
    margin-right: 4px;
    margin-bottom: -0.16rem;
}

.chart-wrapper .overlay {
  fill: none;
  pointer-events: all;
}

.chart-wrapper .focus circle {
  fill: crimson;
  stroke: crimson;
  stroke-width: 2px;
  fill-opacity: 15%;
}
.chart-wrapper .focus.line {
    stroke: steelblue;
    stroke-dasharray: 2,5;
    stroke-width: 2;
    opacity: 0.5;
}

@media (max-width:500px){
    .chart-wrapper .line {stroke-width: 3px;}
    .chart-wrapper .legend {font-size: 14px;}
}
</style>
<!--<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
</head>
<body>

<div class="chart-wrapper" id="chart-line1"></div><p>Total number of sets</p>

<div class="chart-wrapper" id="chart-line2"></div><p>Average unique to total piece ratio</p>

<div class="chart-wrapper" id="chart-line3"></div><p>Average Piece Count per Set</p>

<div class="chart-wrapper" id="chart-line4"></div><p>Std Deviation of Piece Count</p>
<pre id="data">
year,total_number,avg_of_pieces,unique_to_total,pieces_std&r
1980,58,175.69,0.34,195.04&r
1981,39,176.59,0.42,178.06&r
1982,32,128.84,0.49,141.34&r
1983,37,161.7,0.44,146.42&r
1984,47,132.96,0.48,136.47&r
1985,83,153.63,0.46,164.7&r
1986,76,151.24,0.43,139.38&r
1987,80,162.64,0.44,165.15&r
1988,52,160.98,0.49,200.38&r
1989,67,160.94,0.48,179.9&r
1990,73,212.95,0.46,217.24&r
1991,79,171.47,0.47,191.78&r
1992,69,165.84,0.47,185.26&r
1993,80,177.41,0.49,194.95&r
1994,82,172.59,0.52,238.62&r
1995,93,214.34,0.42,212.14&r
1996,117,228.08,0.46,283.81&r
1997,138,170.17,0.5,188.77&r
1998,206,204.62,0.47,233.01&r
1999,185,173.11,0.5,213.55&r
2000,164,193.84,0.48,368.76&r
2001,156,200.83,0.47,315.7&r
2002,183,209.93,0.47,309.17&r
2003,213,194.31,0.47,237.46&r
2004,190,188.77,0.46,241.72&r
2005,222,251.73,0.46,399.79&r
2006,188,349.3,0.4,385.46&r
2007,186,383.73,0.41,562&r
2008,223,373.9,0.41,567.95&r
2009,212,341.54,0.43,423.6&r
2010,207,385.93,0.43,483.08&r
2011,236,322.03,0.46,429.87&r
2012,287,302.83,0.48,386.72&r
2013,303,325.49,0.48,425.49&r
2014,355,312.3,0.48,427.54&r
2015,190,278.81,0.47,391.04
</pre>
<footer>
<script type="text/javascript">
    // d3.csv('http://localhost:8000/lego/setinfo201505.csv',
     d3.csv(d3.select("pre#data").text(),
        function(error, data) {
            data.forEach(function(d) {
                d.year = +d.year;
                d.num_sets = +d.num_sets;
                d.unique_to_total = +d.unique_to_total;
                d.avg_piece_count = +d.avg_piece_count;
                d.piece_count_std = +d.piece_count_std;
            });

            var cys =   {
                        'Number of Sets': {column:'num_sets'},
                        'Average Piece Count':{column:'avg_piece_count'}
                        }
            var chart1 = makeLineChart(data, 'year', cys, {xAxis:'Years',yAxis:'Pieces'})
              .bind("#chart-line1")
              .render();

            var chart2 = makeLineChart(data, 'year',{'Unique to Total':{column:'unique_to_total'}}, {xAxis:'Years', yAxis:'Unique to Total'});
            chart2.bind("#chart-line2");
            chart2.render();

            var cys = {'Average Piece Count':{column:'avg_piece_count'}};
            var chart3 = makeLineChart(data, 'year', cys, {xAxis:'Years',yAxis:'Pieces'});
            chart3.bind("#chart-line3");
            chart3.yFormatter = chart3.formatAsNumber;
            chart3.render();

            var chart4 = makeLineChart(
                data, 'year',
                {
                    'Piece Cound StDev':{column:'piece_count_std'},
                    'Average Piece Count':{column:'avg_piece_count'},
                    'Number of Sets':{column:'num_sets'}
                },
                {xAxis:'Years',yAxis:'Pieces'});
            chart4.bind("#chart-line4");
            chart4.render();

        });


    function makeLineChart(dataset, xName, yObjs, axisLables) {
        var obj = {};
        var color  = d3.scale.category10()
        obj.xAxisLable = axisLables.xAxis
        obj.yAxisLable = axisLables.yAxis
        /*
        yObjsects format:
        {y1:{column:'',name:'name',color:'color'},y2}
        */

        obj.data = dataset;
        obj.margin = {top:15, right: 60, bottom: 30, left: 50};
        obj.width = 650 - obj.margin.left - obj.margin.right;
        obj.height = 480 - obj.margin.top - obj.margin.bottom;

        // So we can pass the x and y as strings when creating the function
        obj.xFunct = new Function('d', 'return d.'+xName);

      // For each yObjs argument, create a yFunction
        function getYFn(column) {
            return function (d) {
                return d[column];
            };
        };

        // Object instead of array
        obj.yFuncts =  []
        for (y in yObjs) {
            yObjs[y].name = y
            yObjs[y].yFunct = getYFn(yObjs[y].column); //Need this  list for the ymax function
            obj.yFuncts.push(yObjs[y].yFunct);
        };

      //Formatter functions for the axes
        obj.formatAsNumber = d3.format(".0f");
        obj.formatAsDecimal = d3.format(".2f");
        obj.formatAsCurrency = d3.format("$.2f");
        obj.formatAsFloat = function (d) {
            if(d % 1 != 0) {
                return d3.format(".2f")(d);
            } else {
                return d3.format(".0f")(d);
            };
        };

        obj.xFormatter = obj.formatAsNumber
        obj.yFormatter = obj.formatAsFloat

        obj.bisectYear = d3.bisector(obj.xFunct).left; //< Can be overridden in definition

        //Create scale functions
        obj.xScale = d3.scale.linear()
            .range([0, obj.width])
            .domain(d3.extent(obj.data, obj.xFunct)); //< Can be overridden in definition

      // Get the max of every yFunct
        obj.max = function (fn) {return d3.max(obj.data, fn)};
        obj.yScale = d3.scale.linear()
            .range([obj.height, 0])
            .domain([0, d3.max(obj.yFuncts.map(obj.max))]);

        obj.formatAsYear = d3.format("");

        //Create axis
        obj.xAxis = d3.svg.axis()
            .scale(obj.xScale)
            .orient("bottom")
            .tickFormat(obj.xFormatter); //< Can be overridden in definition

        obj.yAxis = d3.svg.axis()
            .scale(obj.yScale)
            .orient("left")
            .tickFormat(obj.yFormatter); //< Can be overridden in definition


        // Build line building functions
        function getYScaleFn(yObj) {
            return function (d) {
                return obj.yScale(yObjs[yObj].yFunct(d));
            };
        };
        for (yObj in yObjs) {
            yObjs[yObj].line = d3.svg.line()
                .interpolate("cardinal")
                .x(function (d) {return obj.xScale(obj.xFunct(d)); })
                .y(getYScaleFn(yObj));
        };

        obj.svg

        // Change chart size according to window size
        obj.update_svg_size = function () {
            obj.width = parseInt(obj.chartDiv.style("width"),10) - (obj.margin.left + obj.margin.right);

            obj.height = parseInt(obj.chartDiv.style("height"),10) - (obj.margin.top + obj.margin.bottom);

            /* Update the range of the scale with new width/height */
            obj.xScale.range([0, obj.width]);
            obj.yScale.range([obj.height, 0]);

            if (!obj.svg) {return false;}

            /* Else Update the axis with the new scale */
            obj.svg.select('.x.axis')
                .attr("transform", "translate(0," + obj.height + ")")
                .call(obj.xAxis);
            obj.svg.select('.x.axis .label')
                .attr("x", obj.width/2);

            obj.svg.select('.y.axis')
                .call(obj.yAxis);
            obj.svg.select('.y.axis .label')
                .attr("x", -obj.height/2);

            /* Force D3 to recalculate and update the line */
            for (y in yObjs) {
                yObjs[y].path.attr("d", yObjs[y].line);
            };

            d3.selectAll(".focus.line").attr("y2", obj.height);

            obj.chartDiv.select('svg')
                .attr("width", obj.width + (obj.margin.left + obj.margin.right))
                .attr("height", obj.height + (obj.margin.top + obj.margin.bottom));

            obj.svg.select(".overlay")
                .attr("width", obj.width)
                .attr("height", obj.height);
            return obj;
        };

        obj.bind = function (selector) {
            obj.mainDiv = d3.select(selector);
            // Add all the divs to make it centered and responsive
            obj.mainDiv
                .append("div")
                .attr("class", "inner-wrapper")
                .append("div")
                .attr("class", "outer-box")
                .append("div")
                .attr("class", "inner-box")
            chartSelector = selector+" .inner-box";
            obj.chartDiv = d3.select(chartSelector)
            d3.select(window).on('resize.'+chartSelector,obj.update_svg_size);
            obj.update_svg_size();
            return obj;
        };

        // Render the chart
        obj.render = function () {
            //Create SVG element
            obj.svg = obj.chartDiv
                .append("svg")
                .attr("class", "chart-area")
                .attr("width", obj.width + (obj.margin.left + obj.margin.right))
                .attr("height", obj.height + (obj.margin.top + obj.margin.bottom))
                .append("g")
                .attr("transform", "translate(" + obj.margin.left + "," + obj.margin.top + ")");

            // Draw Lines
            for (y in yObjs) {
                yObjs[y].path = obj.svg.append("path")
                    .datum(obj.data)
                    .attr("class", "line")
                    .attr("d", yObjs[y].line)
                    .style("stroke", color(y))
                    .attr("data-series",y)
                    .on("mouseover", function() {focus.style("display", null);})
                    .on("mouseout", function() {focus.transition().delay(700).style("display", "none");})
                    .on("mousemove", mousemove);
            };

            // Draw Axis
            obj.svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + obj.height + ")")
                .call(obj.xAxis)
                .append("text")
                    .attr("class", "label")
                    .attr("x", obj.width / 2)
                    .attr("y", 30)
                    .style("text-anchor", "middle")
                    .text(obj.xAxisLable);

            obj.svg.append("g")
                .attr("class", "y axis")
                .call(obj.yAxis)
                .append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -42)
                    .attr("x", -obj.height/2)
                    .attr("dy", ".71em")
                    .style("text-anchor", "middle")
                    .text(obj.yAxisLable);

            //Draw tooltips
            var focus = obj.svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            for (y in yObjs)  {
                yObjs[y].tooltip = focus.append("g")
                yObjs[y].tooltip.append("circle").attr("r", 5),
                yObjs[y].tooltip.append("text").attr("x", 9).attr("dy", ".35em")
            };
            // Year label
            focus.append("text")
                .attr("class", "focus year")
                .attr("x", 9)
                .attr("y", 7);
            // Focus line
            focus.append("line")
                .attr("class", "focus line")
                .attr("y1", 0)
                .attr("y2", obj.height);

            //Draw legend
            var legend = obj.mainDiv.append('div')
                .attr("class","legend")
            for (y in yObjs) {
                series = legend.append('div');
                series.append('div')
                    .attr("class", "series-marker")
                    .style("background-color",color(y));
                series.append('p')
                    .text(y);
                yObjs[y].legend = series;
            };


            // Overlay to capture hover
            obj.svg.append("rect")
                .attr("class", "overlay")
                .attr("width", obj.width)
                .attr("height", obj.height)
                .on("mouseover", function() { focus.style("display", null); })
                .on("mouseout", function() { focus.style("display", "none"); })
                .on("mousemove", mousemove);

            return obj;
            function mousemove() {
                var x0 = obj.xScale.invert(d3.mouse(this)[0]),
                    i = obj.bisectYear(dataset, x0, 1),
                    d0 = obj.data[i - 1],
                    d1 = obj.data[i];
                try {
                    var d = x0 - obj.xFunct(d0) > obj.xFunct(d1) - x0 ? d1 : d0;
                } catch (e)  { return;}
                minY = obj.height;
                for (y in yObjs) {
                    yObjs[y].tooltip.attr("transform", "translate(" + obj.xScale(obj.xFunct(d)) + "," + obj.yScale(yObjs[y].yFunct(d)) + ")");
                    yObjs[y].tooltip.select("text").text(obj.yFormatter(yObjs[y].yFunct(d)));
                    minY = Math.min(minY, obj.yScale(yObjs[y].yFunct(d)));
                };
                focus.select(".focus.line").attr("transform","translate("+obj.xScale(obj.xFunct(d))+")").attr("y1",minY);
                focus.select(".focus.year").text("Year: "+obj.xFormatter(obj.xFunct(d)));
            };

        };
    return obj;
    };

</script>
</footer>
</body>
</html>
