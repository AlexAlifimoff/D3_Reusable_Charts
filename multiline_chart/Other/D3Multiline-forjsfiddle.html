<html>
<head>
<style>

.chart-wrapper {
    max-width: 650px;
    min-width: 304px;
    margin: 8px auto;
    background-color: #FAF7F7;
}

.chart-wrapper .inner-wrapper {
    position: relative;
    padding-bottom: 50%;
    width: 100%;
}

.chart-wrapper .outer-box {
    position: absolute;
    top: 0; bottom: 0; left: 0; right: 0;
}

.chart-wrapper .inner-box {
    width: 100%;
    height: 100%;
}

.chart-wrapper text {
  font-family: sans-serif;
  font-size: 11px;
}

.chart-wrapper p {
    font-size: 16px;
    margin-top:5px;
    margin-bottom: 40px;
}

.chart-wrapper .axis path,
.chart-wrapper .axis line {
    fill: none;
    stroke: #1F1F2E;
    stroke-opacity: 0.7;
    shape-rendering: crispEdges;

}
.chart-wrapper .axis path {
  stroke-width: 2px;
}

.chart-wrapper .line {
  fill: none;
  stroke: steelblue;
  stroke-width: 5px;
}

.chart-wrapper .legend  {
    min-width: 200px;
    display: flex;
    justify-content: flex-start;
    flex-wrap: wrap;
    font-size: 16px;
    padding: 10px 40px;
}
.chart-wrapper .legend > div {
    margin: 0px 25px 10px 0px;
    flex-grow: 0;
}
.chart-wrapper .legend p {
    display:inline;
    font-size: 0.8em;
    font-family: sans-serif;
    font-weight: 600;
}
.chart-wrapper .legend .series-marker {
    height: 1em;
    width: 1em;
    border-radius: 35%;
    background-color: crimson;
    display: inline-block;
    margin-right: 4px;
    margin-bottom: -0.16rem;
}

.chart-wrapper .overlay {
  fill: none;
  pointer-events: all;
}

.chart-wrapper .focus circle {
  fill: crimson;
  stroke: crimson;
  stroke-width: 2px;
  fill-opacity: 15%;
}
.chart-wrapper .focus.line {
    stroke: steelblue;
    stroke-dasharray: 2,5;
    stroke-width: 2;
    opacity: 0.5;
}

@media (max-width:500px){
    .chart-wrapper .line {stroke-width: 3px;}
    .chart-wrapper .legend {font-size: 14px;}
}
</style>
<!--<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
</head>
<body>

<div class="chart-wrapper" id="chart-line1"></div><p>Total number of sets</p>

<div class="chart-wrapper" id="chart-line2"></div><p>Average unique to total piece ratio</p>

<div class="chart-wrapper" id="chart-line3"></div><p>Average Piece Count per Set</p>

<div class="chart-wrapper" id="chart-line4"></div><p>Std Deviation of Piece Count</p>

<footer>
<script type="text/javascript">
    data =
    [
{
"year":1980,
"variableA":58,
"avg_of_pieces":175.69,
"unique_to_total":0.34,
"pieces_std":195.04
},
{
"year":1981,
"variableA":39,
"avg_of_pieces":176.59,
"unique_to_total":0.42,
"pieces_std":178.06
},
{
"year":1982,
"variableA":32,
"avg_of_pieces":128.84,
"unique_to_total":0.49,
"pieces_std":141.34
},
{
"year":1983,
"variableA":37,
"avg_of_pieces":161.7,
"unique_to_total":0.44,
"pieces_std":146.42
},
{
"year":1984,
"variableA":47,
"avg_of_pieces":132.96,
"unique_to_total":0.48,
"pieces_std":136.47
},
{
"year":1985,
"variableA":83,
"avg_of_pieces":153.63,
"unique_to_total":0.46,
"pieces_std":164.7
},
{
"year":1986,
"variableA":76,
"avg_of_pieces":151.24,
"unique_to_total":0.43,
"pieces_std":139.38
},
{
"year":1987,
"variableA":80,
"avg_of_pieces":162.64,
"unique_to_total":0.44,
"pieces_std":165.15
},
{
"year":1988,
"variableA":52,
"avg_of_pieces":160.98,
"unique_to_total":0.49,
"pieces_std":200.38
},
{
"year":1989,
"variableA":67,
"avg_of_pieces":160.94,
"unique_to_total":0.48,
"pieces_std":179.9
},
{
"year":1990,
"variableA":73,
"avg_of_pieces":212.95,
"unique_to_total":0.46,
"pieces_std":217.24
},
{
"year":1991,
"variableA":79,
"avg_of_pieces":171.47,
"unique_to_total":0.47,
"pieces_std":191.78
},
{
"year":1992,
"variableA":69,
"avg_of_pieces":165.84,
"unique_to_total":0.47,
"pieces_std":185.26
},
{
"year":1993,
"variableA":80,
"avg_of_pieces":177.41,
"unique_to_total":0.49,
"pieces_std":194.95
},
{
"year":1994,
"variableA":82,
"avg_of_pieces":172.59,
"unique_to_total":0.52,
"pieces_std":238.62
},
{
"year":1995,
"variableA":93,
"avg_of_pieces":214.34,
"unique_to_total":0.42,
"pieces_std":212.14
},
{
"year":1996,
"variableA":117,
"avg_of_pieces":228.08,
"unique_to_total":0.46,
"pieces_std":283.81
},
{
"year":1997,
"variableA":138,
"avg_of_pieces":170.17,
"unique_to_total":0.5,
"pieces_std":188.77
},
{
"year":1998,
"variableA":206,
"avg_of_pieces":204.62,
"unique_to_total":0.47,
"pieces_std":233.01
},
{
"year":1999,
"variableA":185,
"avg_of_pieces":173.11,
"unique_to_total":0.5,
"pieces_std":213.55
},
{
"year":2000,
"variableA":164,
"avg_of_pieces":193.84,
"unique_to_total":0.48,
"pieces_std":368.76
},
{
"year":2001,
"variableA":156,
"avg_of_pieces":200.83,
"unique_to_total":0.47,
"pieces_std":315.7
},
{
"year":2002,
"variableA":183,
"avg_of_pieces":209.93,
"unique_to_total":0.47,
"pieces_std":309.17
},
{
"year":2003,
"variableA":213,
"avg_of_pieces":194.31,
"unique_to_total":0.47,
"pieces_std":237.46
},
{
"year":2004,
"variableA":190,
"avg_of_pieces":188.77,
"unique_to_total":0.46,
"pieces_std":241.72
},
{
"year":2005,
"variableA":222,
"avg_of_pieces":251.73,
"unique_to_total":0.46,
"pieces_std":399.79
},
{
"year":2006,
"variableA":188,
"avg_of_pieces":349.3,
"unique_to_total":0.4,
"pieces_std":385.46
},
{
"year":2007,
"variableA":186,
"avg_of_pieces":383.73,
"unique_to_total":0.41,
"pieces_std":562
},
{
"year":2008,
"variableA":223,
"avg_of_pieces":373.9,
"unique_to_total":0.41,
"pieces_std":567.95
},
{
"year":2009,
"variableA":212,
"avg_of_pieces":341.54,
"unique_to_total":0.43,
"pieces_std":423.6
},
{
"year":2010,
"variableA":207,
"avg_of_pieces":385.93,
"unique_to_total":0.43,
"pieces_std":483.08
},
{
"year":2011,
"variableA":236,
"avg_of_pieces":322.03,
"unique_to_total":0.46,
"pieces_std":429.87
},
{
"year":2012,
"variableA":287,
"avg_of_pieces":302.83,
"unique_to_total":0.48,
"pieces_std":386.72
},
{
"year":2013,
"variableA":303,
"avg_of_pieces":325.49,
"unique_to_total":0.48,
"pieces_std":425.49
},
{
"year":2014,
"variableA":355,
"avg_of_pieces":312.3,
"unique_to_total":0.48,
"pieces_std":427.54
},
{
"year":2015,
"variableA":190,
"avg_of_pieces":278.81,
"unique_to_total":0.47,
"pieces_std":391.04
}
]
    // d3.csv(d3.csv.parse()'http://localhost:8000/lego/setinfo201505.csv',
    //     function(error, data) {
    //         data.forEach(function(d) {
    //             d.year = +d.year;
    //             d.num_sets = +d.num_sets;
    //             d.unique_to_total = +d.unique_to_total;
    //             d.avg_piece_count = +d.avg_piece_count;
    //             d.piece_count_std = +d.piece_count_std;
    //         });

            var cys =   {
                        'Total Number': {column:'variableA'},
                        'Average Pieces':{column:'avg_of_pieces'}
                        }
            var chart1 = makeLineChart(data, 'year', cys, {xAxis:'Years',yAxis:'Pieces'})
              .bind("#chart-line1")
              .render();

            var chart2 = makeLineChart(data, 'year',{'Unique to Total':{column:'unique_to_total'}}, {xAxis:'Years', yAxis:'Unique to Total'});
            chart2.bind("#chart-line2");
            chart2.render();

            var cys = {'Average Pieces':{column:'avg_of_pieces'}};
            var chart3 = makeLineChart(data, 'year', cys, {xAxis:'Years',yAxis:'Total'});
            chart3.bind("#chart-line3");
            chart3.yFormatter = chart3.formatAsNumber;
            chart3.render();

            var chart4 = makeLineChart(
                data, 'year',
                {
                    'Piece StDev':{column:'pieces_std'},
                    'Average Pieces':{column:'avg_of_pieces'},
                    'Total Number':{column:'variableA'}
                },
                {xAxis:'Years',yAxis:'Total'});
            chart4.bind("#chart-line4");
            chart4.render();

        // });


    function makeLineChart(dataset, xName, yObjs, axisLables) {
        var obj = {};
        var color  = d3.scale.category10()
        obj.xAxisLable = axisLables.xAxis
        obj.yAxisLable = axisLables.yAxis
        /*
        yObjsects format:
        {y1:{column:'',name:'name',color:'color'},y2}
        */

        obj.data = dataset;
        obj.margin = {top:15, right: 60, bottom: 30, left: 50};
        obj.width = 650 - obj.margin.left - obj.margin.right;
        obj.height = 480 - obj.margin.top - obj.margin.bottom;

        // So we can pass the x and y as strings when creating the function
        obj.xFunct = new Function('d', 'return d.'+xName);

      // For each yObjs argument, create a yFunction
        function getYFn(column) {
            return function (d) {
                return d[column];
            };
        };

        // Object instead of array
        obj.yFuncts =  []
        for (y in yObjs) {
            yObjs[y].name = y
            yObjs[y].yFunct = getYFn(yObjs[y].column); //Need this  list for the ymax function
            obj.yFuncts.push(yObjs[y].yFunct);
        };

      //Formatter functions for the axes
        obj.formatAsNumber = d3.format(".0f");
        obj.formatAsDecimal = d3.format(".2f");
        obj.formatAsCurrency = d3.format("$.2f");
        obj.formatAsFloat = function (d) {
            if(d % 1 != 0) {
                return d3.format(".2f")(d);
            } else {
                return d3.format(".0f")(d);
            };
        };

        obj.xFormatter = obj.formatAsNumber
        obj.yFormatter = obj.formatAsFloat

        obj.bisectYear = d3.bisector(obj.xFunct).left; //< Can be overridden in definition

        //Create scale functions
        obj.xScale = d3.scale.linear()
            .range([0, obj.width])
            .domain(d3.extent(obj.data, obj.xFunct)); //< Can be overridden in definition

      // Get the max of every yFunct
        obj.max = function (fn) {return d3.max(obj.data, fn)};
        obj.yScale = d3.scale.linear()
            .range([obj.height, 0])
            .domain([0, d3.max(obj.yFuncts.map(obj.max))]);

        obj.formatAsYear = d3.format("");

        //Create axis
        obj.xAxis = d3.svg.axis()
            .scale(obj.xScale)
            .orient("bottom")
            .tickFormat(obj.xFormatter); //< Can be overridden in definition

        obj.yAxis = d3.svg.axis()
            .scale(obj.yScale)
            .orient("left")
            .tickFormat(obj.yFormatter); //< Can be overridden in definition


        // Build line building functions
        function getYScaleFn(yObj) {
            return function (d) {
                return obj.yScale(yObjs[yObj].yFunct(d));
            };
        };
        for (yObj in yObjs) {
            yObjs[yObj].line = d3.svg.line()
                .interpolate("cardinal")
                .x(function (d) {return obj.xScale(obj.xFunct(d)); })
                .y(getYScaleFn(yObj));
        };

        obj.svg

        // Change chart size according to window size
        obj.update_svg_size = function () {
            obj.width = parseInt(obj.chartDiv.style("width"),10) - (obj.margin.left + obj.margin.right);

            obj.height = parseInt(obj.chartDiv.style("height"),10) - (obj.margin.top + obj.margin.bottom);

            /* Update the range of the scale with new width/height */
            obj.xScale.range([0, obj.width]);
            obj.yScale.range([obj.height, 0]);

            if (!obj.svg) {return false;}

            /* Else Update the axis with the new scale */
            obj.svg.select('.x.axis')
                .attr("transform", "translate(0," + obj.height + ")")
                .call(obj.xAxis);
            obj.svg.select('.x.axis .label')
                .attr("x", obj.width/2);

            obj.svg.select('.y.axis')
                .call(obj.yAxis);
            obj.svg.select('.y.axis .label')
                .attr("x", -obj.height/2);

            /* Force D3 to recalculate and update the line */
            for (y in yObjs) {
                yObjs[y].path.attr("d", yObjs[y].line);
            };

            d3.selectAll(".focus.line").attr("y2", obj.height);

            obj.chartDiv.select('svg')
                .attr("width", obj.width + (obj.margin.left + obj.margin.right))
                .attr("height", obj.height + (obj.margin.top + obj.margin.bottom));

            obj.svg.select(".overlay")
                .attr("width", obj.width)
                .attr("height", obj.height);
            return obj;
        };

        obj.bind = function (selector) {
            obj.mainDiv = d3.select(selector);
            // Add all the divs to make it centered and responsive
            obj.mainDiv
                .append("div")
                .attr("class", "inner-wrapper")
                .append("div")
                .attr("class", "outer-box")
                .append("div")
                .attr("class", "inner-box")
            chartSelector = selector+" .inner-box";
            obj.chartDiv = d3.select(chartSelector)
            d3.select(window).on('resize.'+chartSelector,obj.update_svg_size);
            obj.update_svg_size();
            return obj;
        };

        // Render the chart
        obj.render = function () {
            //Create SVG element
            obj.svg = obj.chartDiv
                .append("svg")
                .attr("class", "chart-area")
                .attr("width", obj.width + (obj.margin.left + obj.margin.right))
                .attr("height", obj.height + (obj.margin.top + obj.margin.bottom))
                .append("g")
                .attr("transform", "translate(" + obj.margin.left + "," + obj.margin.top + ")");

            // Draw Lines
            for (y in yObjs) {
                yObjs[y].path = obj.svg.append("path")
                    .datum(obj.data)
                    .attr("class", "line")
                    .attr("d", yObjs[y].line)
                    .style("stroke", color(y))
                    .attr("data-series",y)
                    .on("mouseover", function() {focus.style("display", null);})
                    .on("mouseout", function() {focus.transition().delay(700).style("display", "none");})
                    .on("mousemove", mousemove);
            };

            // Draw Axis
            obj.svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + obj.height + ")")
                .call(obj.xAxis)
                .append("text")
                    .attr("class", "label")
                    .attr("x", obj.width / 2)
                    .attr("y", 30)
                    .style("text-anchor", "middle")
                    .text(obj.xAxisLable);

            obj.svg.append("g")
                .attr("class", "y axis")
                .call(obj.yAxis)
                .append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -42)
                    .attr("x", -obj.height/2)
                    .attr("dy", ".71em")
                    .style("text-anchor", "middle")
                    .text(obj.yAxisLable);

            //Draw tooltips
            var focus = obj.svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            for (y in yObjs)  {
                yObjs[y].tooltip = focus.append("g")
                yObjs[y].tooltip.append("circle").attr("r", 5),
                yObjs[y].tooltip.append("text").attr("x", 9).attr("dy", ".35em")
            };
            // Year label
            focus.append("text")
                .attr("class", "focus year")
                .attr("x", 9)
                .attr("y", 7);
            // Focus line
            focus.append("line")
                .attr("class", "focus line")
                .attr("y1", 0)
                .attr("y2", obj.height);

            //Draw legend
            var legend = obj.mainDiv.append('div')
                .attr("class","legend")
            for (y in yObjs) {
                series = legend.append('div');
                series.append('div')
                    .attr("class", "series-marker")
                    .style("background-color",color(y));
                series.append('p')
                    .text(y);
                yObjs[y].legend = series;
            };


            // Overlay to capture hover
            obj.svg.append("rect")
                .attr("class", "overlay")
                .attr("width", obj.width)
                .attr("height", obj.height)
                .on("mouseover", function() { focus.style("display", null); })
                .on("mouseout", function() { focus.style("display", "none"); })
                .on("mousemove", mousemove);

            return obj;
            function mousemove() {
                var x0 = obj.xScale.invert(d3.mouse(this)[0]),
                    i = obj.bisectYear(dataset, x0, 1),
                    d0 = obj.data[i - 1],
                    d1 = obj.data[i];
                try {
                    var d = x0 - obj.xFunct(d0) > obj.xFunct(d1) - x0 ? d1 : d0;
                } catch (e)  { return;}
                minY = obj.height;
                for (y in yObjs) {
                    yObjs[y].tooltip.attr("transform", "translate(" + obj.xScale(obj.xFunct(d)) + "," + obj.yScale(yObjs[y].yFunct(d)) + ")");
                    yObjs[y].tooltip.select("text").text(obj.yFormatter(yObjs[y].yFunct(d)));
                    minY = Math.min(minY, obj.yScale(yObjs[y].yFunct(d)));
                };
                focus.select(".focus.line").attr("transform","translate("+obj.xScale(obj.xFunct(d))+")").attr("y1",minY);
                focus.select(".focus.year").text("Year: "+obj.xFormatter(obj.xFunct(d)));
            };

        };
    return obj;
    };

</script>
</footer>
</body>
</html>
